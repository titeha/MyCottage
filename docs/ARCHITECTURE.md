# Архитектура (целевой вид, v0.5)

## 1) Общая схема

Клиенты:
- Android (телефон/планшет)
- iOS (позже)
- Web Portal (браузер)

→ Cloud API (OIDC + REST/JSON)  
→ Core Data (PostgreSQL) + Media (S3)  
→ Domain Services (погода/агроклимат, почвы, справочники, техкарты)  
→ AI Services (LLM + CV + RAG)  
→ Event/Rules Engine (ИИ‑наблюдения → предупреждения/задачи)  
→ внешние провайдеры (погода, радиация, почвенные слои, карты).

Принцип: **офлайн‑first** на мобильных клиентах (дневник и план участка работают без интернета). Облако добавляет синхронизацию, ИИ, расчёты на базе фактической погоды и обновляемые справочники.

## 2) Клиенты

### 2.1 Android
Рекомендуемый стек:
- Kotlin + Jetpack Compose
- Room (SQLite)
- WorkManager (синк/прогноз/очереди фото)
- Adaptive UI (телефоны + планшеты)

Архитектурный стиль:
- Clean Architecture: UI → Domain → Data
- Sync Engine: очередь изменений + разрешение конфликтов (server wins / last write wins / merge per field — определяется в ТЗ)

### 2.2 Планшеты (Android)
Требования:
- адаптивная навигация: BottomNav на телефоне → NavigationRail/Drawer на планшете;
- multi‑pane: список посадок слева, карточка справа;
- drag&drop на экране “План участка”.

### 2.3 iOS (позже)
Чтобы iOS не стал “переписыванием с нуля”:
- API‑first: одинаковые доменные контракты;
- общий слой моделей (`shared/`) через OpenAPI‑генерацию или KMP;
- UI и platform‑specific сервисы (уведомления/фото) остаются нативными.

## 3) Web Portal

Назначение:
- сообщество (форум/вопросы‑ответы/профили);
- инструменты “удобнее на компьютере”:
  - план участка (drag&drop, масштабирование, печать),
  - массовые правки посадок/задач,
  - сезонная аналитика (погода/урожай/работы),
  - эксперименты “авто‑разметка/рассадка по фото”.

Рекомендуемый путь:
- отдельный SPA (например Next.js) + Cloud API;
- форум как готовый движок (например Discourse) с SSO через OIDC (Keycloak).

## 4) Cloud (backend)

### 4.1 Базовые компоненты
- Auth (OIDC): Keycloak/self-host или managed
- Core API (монолит с модулями или микросервисы):
  - Core Data: Sites/Zones/Plantings/Tasks/Journal/PlotPlan
  - Sync: версии, конфликты, аудит
  - Media: загрузка/выдача фото (S3)
- Weather/Agroclimate Service:
  - кэш прогноза/истории
  - расчёт профиля сезона (безморозный период, GDD, осадки, солнечность)
- Soil Service:
  - профиль почвы (ручной/карта/лаборатория)
  - планы восстановления плодородия
- Reference Service:
  - культуры/сорта
  - техкарты выращивания
  - справочник СЗР/удобрений (на базе официальных реестров)
  - рецепты/заготовки (кулинарная база)

### 4.2 AI Service (LLM + CV + RAG)
Компоненты:
- LLM Orchestrator (чат, планирование, объяснение)
- CV Inference (поэтапно): идентификация/болезни/обрезка
- RAG: извлечение знаний из справочников/техкарт/реестров/FAQ
- Safety Layer:
  - запрет “самодельных смесей”, дозировок без этикетки,
  - обязательные дисклеймеры и запрос подтверждения для рискованных действий.

### 4.3 Event / Rules Engine (ключевой слой “умности”)
События (примеры):
- AIObservationCreated (опознали вредителя “совка”)
- WeatherAlert (ожидается заморозок)
- HarvestWindowReached (пора собирать)
- SoilRiskDetected (pH/органика вне нормы)

Действия:
- создать Alert пользователю
- предложить набор задач (Task Proposals) и попросить подтверждение
- добавить задачи в календарь (после подтверждения)
- предложить материалы/техкарту/рецепты

Принцип: **ничего опасного не делается “автоматически”**. Любая обработка/химия — только как предложение, с обязательным подтверждением и ссылкой на официальную инструкцию/регламент.

## 5) Автоматизация (позже)
Интеграции:
- Home Assistant / MQTT
- расписания полива
- “умные правила” на основе погоды (осадки/ET₀) и задач дневника

Безопасность:
- отдельные токены/ключи, шифрование секретов;
- режим “dry run” (сначала только подсказки, потом управление).

